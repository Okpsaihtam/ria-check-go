<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIA Check & Go - √âvaluation de Conformit√© IA</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ü§ñ</span>
                <h1>RIA Check & Go</h1>
            </div>
            <p class="subtitle">Assistant de conformit√© au R√®glement sur l'Intelligence Artificielle</p>
        </header>

        <!-- Zone de chat -->
        <div class="chat-wrapper">
            <div id="chat-container" class="chat-container">
                <div class="welcome-message">
                    <h2>üëã Bienvenue !</h2>
                    <p>Je suis votre assistant expert en conformit√© RIA.</p>
                    <p>Je vais vous poser quelques questions pour √©valuer le niveau de risque de votre syst√®me d'IA.</p>
                    <button onclick="startConversation()" class="btn-primary">Commencer l'√©valuation</button>
                </div>
            </div>

            <!-- Zone de saisie -->
            <div id="input-area" class="input-area" style="display: none;">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="Tapez votre message ici..."
                    onkeypress="handleKeyPress(event)"
                    autocomplete="off"
                >
                <button onclick="sendMessage()" class="btn-send" id="send-btn">
                    <span>Envoyer</span>
                </button>
            </div>
        </div>

        <!-- Zone de r√©sultats (cach√©e initialement) -->
        <div id="results-section" class="results-section" style="display: none;">
            <h2>üìä R√©sultats de l'√©valuation</h2>
            
            <div class="score-card">
                <div class="score-circle" id="score-circle">
                    <span class="score-value" id="score-value">-</span>
                    <span class="score-label">/100</span>
                </div>
                <div class="risk-info">
                    <h3 id="risk-level">-</h3>
                    <p id="risk-description">-</p>
                </div>
            </div>

            <div class="recommendations-card">
                <h3>üí° Recommandations</h3>
                <ul id="recommendations-list"></ul>
            </div>

            <div class="justification-card">
                <h3>üìã Justification</h3>
                <p id="justification-text">-</p>
            </div>

            <div class="actions">
                <button onclick="generatePDF()" class="btn-primary">
                    üìÑ Voir le rapport complet
                </button>
                <button onclick="requestQuote()" class="btn-secondary">
                    üíº Demander un devis
                </button>
                <button onclick="resetConversation()" class="btn-secondary">
                    üîÑ Nouvelle √©valuation
                </button>
            </div>
        </div>
    </div>

    <!-- Script principal -->
    <script>
        // √âtat global de l'application
        const appState = {
            conversationStarted: false,
            isWaitingResponse: false,
            messageCount: 0,
            analysisData: null,
            conversationComplete: false,
            totalTokens: 0
        };

        console.log('‚úÖ Application charg√©e');

        // D√©marre la conversation
        function startConversation() {
            console.log('üöÄ D√©marrage...');
            const chatContainer = document.getElementById('chat-container');
            const inputArea = document.getElementById('input-area');
            
            chatContainer.innerHTML = '';
            inputArea.style.display = 'flex';
            appState.conversationStarted = true;
            appState.conversationComplete = false;
            
            sendInitialMessage();
        }

        // Envoie le message initial
        async function sendInitialMessage() {
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Bonjour, je souhaite √©valuer la conformit√© RIA de mon syst√®me d\'IA.'
                    })
                });

                const data = await response.json();
                hideTypingIndicator();
                
                if (data.response) {
                    addMessageToChat('assistant', data.response);
                    appState.messageCount = data.messageCount || 1;
                    appState.totalTokens = data.totalTokens || 0;
                    
                    console.log(`üéØ Tokens utilis√©s: ${data.tokensUsed}`);
                    console.log(`üìä Total tokens: ${data.totalTokens}`);
                }
            } catch (error) {
                console.error('Erreur:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', '‚ùå Erreur de connexion. V√©rifiez que le serveur est d√©marr√©.');
            }
        }

        // Envoie un message utilisateur
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message || appState.isWaitingResponse) return;
            
            addMessageToChat('user', message);
            input.value = '';
            
            appState.isWaitingResponse = true;
            updateSendButton(true);
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                hideTypingIndicator();
                
                if (data.error) {
                    addMessageToChat('assistant', `‚ùå ${data.error}`);
                } else {
                    addMessageToChat('assistant', data.response);
                    appState.messageCount = data.messageCount || appState.messageCount + 1;
                    appState.totalTokens = data.totalTokens || 0;
                    
                    console.log(`üéØ Tokens utilis√©s: ${data.tokensUsed}`);
                    console.log(`üìä Total tokens: ${data.totalTokens}`);
                    
                    // V√©rifier si la conversation est compl√®te
                    if (data.conversationComplete && !appState.conversationComplete) {
                        appState.conversationComplete = true;
                        setTimeout(proposeAnalysis, 1500);
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', '‚ùå Erreur de connexion.');
            } finally {
                appState.isWaitingResponse = false;
                updateSendButton(false);
                input.focus();
            }
        }

        // Ajoute un message au chat
        function addMessageToChat(role, content) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            if (role === 'user') {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Affiche l'indicateur de saisie
        function showTypingIndicator() {
            const chatContainer = document.getElementById('chat-container');
            const old = document.getElementById('typing-indicator');
            if (old) old.remove();
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Masque l'indicateur
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // Met √† jour le bouton d'envoi
        function updateSendButton(disabled) {
            const btn = document.getElementById('send-btn');
            if (btn) {
                btn.disabled = disabled;
                const span = btn.querySelector('span');
                if (span) span.textContent = disabled ? 'Envoi...' : 'Envoyer';
            }
        }

        // G√®re la touche Entr√©e
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Propose l'analyse UNIQUEMENT quand c'est termin√©
        function proposeAnalysis() {
            const chatContainer = document.getElementById('chat-container');
            const proposalDiv = document.createElement('div');
            proposalDiv.className = 'message assistant';
            proposalDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <p><strong>‚úÖ Merci pour ces informations compl√®tes !</strong></p>
                    <p>J'ai maintenant tous les √©l√©ments n√©cessaires pour analyser votre syst√®me d'IA selon le RIA.</p>
                    <p style="margin-top: 10px;">üìä <strong>Tokens utilis√©s:</strong> ${appState.totalTokens} tokens</p>
                    <button onclick="performAnalysis()" class="btn-primary" style="margin-top: 15px; width: 100%;">
                        üìä G√©n√©rer mon rapport de conformit√©
                    </button>
                </div>
            `;
            chatContainer.appendChild(proposalDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Lance l'analyse
        async function performAnalysis() {
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                hideTypingIndicator();
                
                if (data.error) {
                    addMessageToChat('assistant', `‚ùå ${data.error}`);
                    return;
                }
                
                appState.analysisData = data;
                addMessageToChat('assistant', `‚úÖ Analyse termin√©e ! Total de ${data.totalTokensUsed || appState.totalTokens} tokens utilis√©s. Affichage du rapport...`);
                setTimeout(() => displayResults(data), 1000);
                
            } catch (error) {
                console.error('Erreur:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', '‚ùå Erreur lors de l\'analyse.');
            }
        }

        // Affiche les r√©sultats
        function displayResults(data) {
            document.querySelector('.chat-wrapper').style.display = 'none';
            const resultsSection = document.getElementById('results-section');
            resultsSection.style.display = 'block';
            
            document.getElementById('score-value').textContent = data.score;
            
            const color = data.color || '#28a745';
            const scoreCircle = document.getElementById('score-circle');
            scoreCircle.style.borderColor = color;
            scoreCircle.style.color = color;
            
            const riskLevel = document.getElementById('risk-level');
            riskLevel.textContent = data.label || data.riskLevel;
            riskLevel.style.color = color;
            
            document.getElementById('risk-description').textContent = data.description || '';
            
            // Afficher justification avec tokens
            const justificationText = `${data.justification || 'Analyse bas√©e sur vos r√©ponses.'}\n\nüìä Analyse r√©alis√©e avec ${data.totalTokensUsed || appState.totalTokens} tokens (mots du chatbot).`;
            document.getElementById('justification-text').textContent = justificationText;
            
            const list = document.getElementById('recommendations-list');
            list.innerHTML = '';
            (data.recommendations || []).forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                list.appendChild(li);
            });
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            resultsSection.style.opacity = '0';
            setTimeout(() => {
                resultsSection.style.transition = 'opacity 0.5s';
                resultsSection.style.opacity = '1';
            }, 100);
        }

        // G√©n√®re une page de rapport compl√®te
        function generatePDF() {
            if (!appState.analysisData) {
                alert('‚ùå Aucune donn√©e disponible');
                return;
            }
            
            const data = appState.analysisData;
            const totalTokens = data.totalTokensUsed || appState.totalTokens;
            
            // Cr√©er le contenu HTML du rapport
            const reportHTML = `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport RIA - ${data.riskLevel}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }
        .report-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .report-header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .report-header .logo { font-size: 4rem; margin-bottom: 20px; }
        .report-header .date { font-size: 1rem; opacity: 0.9; margin-top: 15px; }
        .report-body { padding: 40px; }
        .score-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            border-left: 8px solid ${data.color || '#28a745'};
        }
        .score-value {
            font-size: 5rem;
            font-weight: bold;
            color: ${data.color || '#28a745'};
            line-height: 1;
        }
        .score-label { font-size: 1.5rem; color: #666; margin-top: 10px; }
        .risk-level {
            font-size: 2.5rem;
            font-weight: bold;
            color: ${data.color || '#28a745'};
            margin: 20px 0;
        }
        .risk-description { font-size: 1.2rem; color: #555; margin-bottom: 10px; }
        .section { margin-bottom: 40px; }
        .section-title {
            font-size: 2rem;
            color: #4f46e5;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4f46e5;
        }
        .section-title .icon { margin-right: 10px; }
        .justification-box {
            background: #f8f9fa;
            border-left: 5px solid #4f46e5;
            padding: 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
        }
        .token-info {
            background: #e0e7ff;
            border-left: 5px solid #4f46e5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 1rem;
            color: #4f46e5;
            font-weight: 600;
        }
        .recommendations-list { list-style: none; }
        .recommendations-list li {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 5px solid ${data.color || '#28a745'};
            font-size: 1.05rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .recommendations-list li:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .recommendations-list li::before {
            content: '‚úì';
            display: inline-block;
            width: 30px;
            height: 30px;
            background: ${data.color || '#28a745'};
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 15px;
            font-weight: bold;
        }
        .footer {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }
        .footer p { margin: 5px 0; opacity: 0.9; }
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-primary:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-2px); }
        @media print {
            body { background: white; padding: 0; }
            .actions { display: none; }
        }
        @media (max-width: 768px) {
            .report-header h1 { font-size: 1.8rem; }
            .score-value { font-size: 3.5rem; }
            .actions { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <div class="logo">ü§ñ</div>
            <h1>RIA Check & Go</h1>
            <h2>Rapport de Conformit√© RIA</h2>
            <div class="date">
                G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
            </div>
        </div>
        
        <div class="report-body">
            <div class="score-section">
                <div class="score-value">${data.score}<span style="font-size: 2.5rem;">/100</span></div>
                <div class="score-label">Score de Conformit√©</div>
                <div class="risk-level">${data.label || data.riskLevel}</div>
                <div class="risk-description">${data.description || ''}</div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><span class="icon">üìã</span>Justification de l'√âvaluation</h2>
                <div class="justification-box">
                    ${data.justification || 'Analyse bas√©e sur les informations fournies lors de l\'√©valuation.'}
                </div>
                <div class="token-info">
                    üìä Analyse r√©alis√©e avec <strong>${totalTokens} tokens</strong> (mots g√©n√©r√©s par le chatbot)
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title"><span class="icon">üí°</span>Recommandations Prioritaires</h2>
                <ul class="recommendations-list">
                    ${(data.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
            
            <div class="actions">
                <button onclick="window.print()" class="btn btn-primary">
                    üñ®Ô∏è Imprimer ce rapport
                </button>
                <button onclick="window.close()" class="btn btn-secondary">
                    ‚úñÔ∏è Fermer
                </button>
                <a href="http://localhost:3000" class="btn btn-secondary">
                    üè† Retour √† l'accueil
                </a>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>RIA Check & Go</strong> - √âvaluation de Conformit√© au R√®glement sur l'IA</p>
            <p>Ce rapport a √©t√© g√©n√©r√© automatiquement par notre assistant IA expert.</p>
            <p>Analyse bas√©e sur ${totalTokens} tokens (mots du chatbot) - ${data.conversationLength || 0} messages √©chang√©s</p>
            <p>Pour toute question ou accompagnement personnalis√©, contactez notre √©quipe d'experts.</p>
        </div>
    </div>
</body>
</html>
            `;
            
            // Ouvrir le rapport dans un nouvel onglet
            const reportWindow = window.open('', '_blank');
            
            if (reportWindow) {
                reportWindow.document.write(reportHTML);
                reportWindow.document.close();
                console.log('‚úÖ Rapport ouvert dans un nouvel onglet');
            } else {
                alert('‚ùå Veuillez autoriser les pop-ups pour afficher le rapport');
            }
        }

        // Demande de devis
        function requestQuote() {
            const name = prompt('üë§ Votre nom :');
            if (!name) return;
            const email = prompt('üìß Votre email :');
            if (!email || !email.includes('@')) {
                alert('‚ùå Email invalide');
                return;
            }
            const company = prompt('üè¢ Entreprise :');
            if (!company) return;
            
            alert(`‚úÖ Demande enregistr√©e !\n\nüë§ ${name}\nüìß ${email}\nüè¢ ${company}\n\nUn expert vous contactera sous 48h.`);
        }

        // R√©initialise
        async function resetConversation() {
            if (!confirm('üîÑ Recommencer une nouvelle √©valuation ?')) return;
            
            try {
                await fetch('/api/reset', { method: 'POST' });
                
                appState.conversationStarted = false;
                appState.messageCount = 0;
                appState.analysisData = null;
                appState.conversationComplete = false;
                appState.totalTokens = 0;
                
                document.querySelector('.chat-wrapper').style.display = 'block';
                document.getElementById('results-section').style.display = 'none';
                document.getElementById('input-area').style.display = 'none';
                
                document.getElementById('chat-container').innerHTML = `
                    <div class="welcome-message">
                        <h2>üëã Bienvenue !</h2>
                        <p>Je suis votre assistant expert en conformit√© RIA.</p>
                        <p>Je vais vous poser quelques questions pour √©valuer le niveau de risque de votre syst√®me d'IA.</p>
                        <button onclick="startConversation()" class="btn-primary">Commencer l'√©valuation</button>
                    </div>
                `;
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la r√©initialisation');
            }
        }
    </script>
</body>
</html>